# 03. конфигурация Hyper-V для Debian 13.2.0 и установка Debian

## Конфигурация Hyper-V для Debian 13.2.0

запустить административный powershell

```powershell
$vmName = "HV17-Debian-13-Java-Dev"
New-VM -Name $vmName -MemoryStartupBytes 4GB -Generation 2 `
  -NewVHDPath "H:\VMs\$vmName\disk-main.vhdx" -NewVHDSizeBytes 150GB

# устанавливает физический размер сектора
Set-VHD -Path "H:\VMs\$vmName\disk-main.vhdx" -PhysicalSectorSizeBytes 4096

# Критично для ядра 6.8: отключить Secure Boot
Set-VMFirmware -VMName $vmName -EnableSecureBoot Off

# Динамическая память с буфером для Java сборок
Set-VMMemory -VMName $vmName -DynamicMemoryEnabled $true `
  -MinimumBytes 2GB -StartupBytes 4GB -MaximumBytes 32GB `
  -Buffer 40

# Процессор: 6 ядер для параллельных сборок
Set-VMProcessor -VMName $vmName -Count 6 -Reserve 30 -Maximum 100

#Включить спуфинг MAC для контейнеров
Set-VMNetworkAdapter -VMName $vmName -MacAddressSpoofing On
```

открыть Hyper-V manager

- нажать редактирование для VM
- Hardware/SCSI Controller/добавить DVD Drive. Location=15. Выбрать iso в "image file"
- нажать Apply
- Hardware/Firmware. поставить "DVD Drive" на первое место в "Boot Order"
- Hardware/Network Adapter выбрать сеть. для "интернета" - external switch
- Management/Integration Service. Включить "guest service" (?)
- Management/checkpoints. выключить "use automatic checkpoints"
- нажать OK

## Установка Debian в ручном режиме

Для VM Gen2 (-Generation 2) необходима конфигурация с EFI

- hyper-V: boot ISO
- Advanced options ...
- ... Expert install
- Choose language. English
  - Country. other, Europe, Russian Federation
  - configure locales. United States en_US.UTF-8; Additional: ru_RU.UTF-8
  - System locale. en_US.UTF-8
- Configure the keyboard. American English
- Detect and mount installation media
- Load installer components from installation media. ничего не выбирать
- Detect network hardware.
- Configure the network. Auto-configure: yes. Waiting: 3. hostname: hv99.
Domain: lab34.dom
- Set up users and password. allow root = No. далее - ввести логин/пароль
- Configure the clock. NTP = Yes. NTP - по умолчанию. Time zone - Moscow+00
- Detect disks
- Partition disks. SCSI1(0,0,0). new partition table = Yes. type = GPT. разбивка диска
  - схема
    - раздел-1: 1gb,"efiData",efi
    - раздел-2: 16gb,"swapData",swap
    - раздел-3: остальное,"mainData",ext4,/
  - нажать "Finish partitioning"
  - write changes = Yes
- Install the base system. Kernel = linux-image-amd64. initrd = targeted
- Configure the package manager. extra media = No. use a network mirror = No.
Services = security, release.
- Select and install software. System = no automatic updates. Participate = No.
Choose: Debian, GNOME, SSH, standard system. *долгая установка*
- Install the GRUB boot loader. Force GRUB = no. Update NVRAM = yes.
Run os-prober = No
- Finish the installation. system clock UTC = Yes. Hyper-V - вытащить диск
при сообщении "Installation complete".
- Hyper-V: Hardware/Firmware/Boot order: поставить DVD Drive в конец списка
и нажать OK
- Hyper-V: запустить ВМ и отредактировать `/etc/apt/sources.list` см. ниже

*примечание* install systemd-boot boot loader = не выполнять

## правка  /etc/apt/sources.list для Debian 13 (trixie)

```txt
# Основной репозиторий
deb https://deb.debian.org/debian trixie main contrib non-free-firmware

# Обновления безопасности
deb https://deb.debian.org/debian-security trixie-security main contrib non-free-firmware

# Обновления (точечные релизы)
deb https://deb.debian.org/debian trixie-updates main contrib non-free-firmware
```

## опции

### проверка физического размера сектора VHDX

```powershell
$vmName = "HV17-Debian-13-Java-Dev"
Get-VHD -Path H:\VMs\$vmName\disk-main.vhdx | 
  Select-Object Path, @{n="LogicalSectorSize";e={$_.LogicalSectorSize}}, `
                @{n="PhysicalSectorSize";e={$_.PhysicalSectorSize}}
```

### Полная оптимизация VHDX

требует предварительного монтирования в режиме только для чтения

```powershell
$vmName = "HV17-Debian-13-Java-Dev"
Mount-VHD H:\VMs\$vmName\disk-main.vhdx -ReadOnly
Optimize-VHD -Path H:\VMs\$vmName\disk-main.vhdx -Mode Full
Dismount-VHD H:\VMs\$vmName\disk-main.vhdx
```

### настройка памяти

```powershell
# Для ВМ с контейнерами/Minikube — ИСПОЛЬЗОВАТЬ СТАТИЧЕСКУЮ ПАМЯТЬ
Set-VMMemory -VMName $vmName -DynamicMemoryEnabled $false -StartupBytes 16GB

# Для простых ВМ без нагрузки — можно использовать динамическую
Set-VMMemory -VMName $vmName -DynamicMemoryEnabled $true `
  -MinimumBytes 2GB -StartupBytes 4GB -MaximumBytes 8GB -MemoryBuffer 20
```

### доп. настройки

[Hyper-V и виртуальные процессоры](https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/manage/manage-hyper-v-scheduler-types#virtual-machine-cpu-resource-controls-and-the-root-scheduler)
