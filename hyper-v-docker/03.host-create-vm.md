# 03. конфигурация Hyper-V для Debian 13.2.0 и установка Debian

## Конфигурация Hyper-V для Debian 13.2.0

запустить административный powershell

```powershell
$vmName = "HV17-Debian-13-Java-Dev"
New-VM -Name $vmName -MemoryStartupBytes 4GB -Generation 2 `
  -NewVHDPath "H:\VMs\$vmName\disk-main.vhdx" -NewVHDSizeBytes 256GB

# устанавливает физический размер сектора
Set-VHD -Path "H:\VMs\$vmName\disk-main.vhdx" -PhysicalSectorSizeBytes 4096

# Критично для ядра 6.8: отключить Secure Boot
Set-VMFirmware -VMName $vmName -EnableSecureBoot Off

# Динамическая память с буфером для Java сборок
Set-VMMemory -VMName $vmName -DynamicMemoryEnabled $true `
  -MinimumBytes 4GB -StartupBytes 4GB -MaximumBytes 32GB `
  -Buffer 40

# Процессор: 6 ядер для параллельных сборок
# подробности - см. "Hyper-V и виртуальные процессоры" ниже
Set-VMProcessor -VMName $vmName -Count 6 -Reserve 30 -Maximum 100

#Включить спуфинг MAC для контейнеров
Set-VMNetworkAdapter -VMName $vmName -MacAddressSpoofing On
```

открыть Hyper-V manager

- нажать редактирование для VM
- Hardware/SCSI Controller/добавить DVD Drive. Location=15. Выбрать iso в "image file"
- нажать Apply
- Hardware/Firmware. поставить "DVD Drive" на первое место в "Boot Order"
- Hardware/Network Adapter выбрать сеть. для "интернета" - external switch
- Management/Integration Service. Включить все сервисы
- Management/checkpoints. выключить "Use automatic checkpoints"
- нажать OK

## Установка Debian в ручном режиме

Для VM Gen2 (-Generation 2) необходима конфигурация с EFI

- hyper-V: boot ISO
- Advanced options ...
- ... Expert install
- Choose language. English
  - Country. other, Europe, Russian Federation
  - configure locales. United States en_US.UTF-8; Additional: ru_RU.UTF-8
  - System locale. en_US.UTF-8
- Configure the keyboard. American English
- Detect and mount installation media
- Load installer components from installation media. ничего не выбирать
- Detect network hardware.
- Configure the network. Auto-configure: yes. Waiting: 3. hostname: hv99.
Domain: lab34.dom
- Set up users and password. allow root = No. далее - ввести логин/пароль
- Configure the clock. NTP = Yes. NTP - по умолчанию. Time zone - Moscow+00
- Detect disks
- Partition disks. Manual. SCSI1(0,0,0). new partition table = Yes. type = GPT
  - схема разбивки диска
    - раздел-1: 1gb,"efiData",efi
    - раздел-2: 16gb,"swapData",swap - разметка от конца
    - раздел-3: остальное,"mainData",ext4,/
  - нажать "Finish partitioning"
  - write changes = Yes
- Install the base system. Kernel = linux-image-amd64. initrd = targeted
- Configure the package manager. extra media = No. use a network mirror = No.
Services = security, release.
- Select and install software. System = no automatic updates. Participate = No.
Choose: Debian, GNOME, SSH, standard system. *долгая установка*
- Install the GRUB boot loader. Force GRUB = no. Update NVRAM = yes.
Run os-prober = No
- Finish the installation. system clock UTC = Yes. Hyper-V - вытащить диск
при сообщении "Installation complete".
- Hyper-V: Hardware/Firmware/Boot order: поставить DVD Drive в конец списка
и нажать OK
- Hyper-V: запустить ВМ и отредактировать `/etc/apt/sources.list` см. ниже

*примечание* install systemd-boot boot loader = не выполнять

## правка  /etc/apt/sources.list для Debian 13 (trixie)

```txt
# Основной репозиторий
deb https://deb.debian.org/debian trixie main contrib non-free-firmware

# Обновления безопасности
deb https://deb.debian.org/debian-security trixie-security main contrib non-free-firmware

# Обновления (точечные релизы)
deb https://deb.debian.org/debian trixie-updates main contrib non-free-firmware
```

*примечания* запуск графического текстового редактор - gnome-text-editor
*примечания* репозиторий на dvd закомментировать, если не используется
  
## Активация Enhanced Session Mode на хосте (Windows)

Откройте PowerShell от имени администратора на хосте:

```powershell
$vmName = "HV17-Debian-13-Java-Dev"
# Включение режима улучшенных сеансов глобально
Set-VMHost -EnableEnhancedSessionMode $true

# Привязка политики к конкретной ВМ
Set-VM -Name "$vmName" -EnhancedSessionTransportType HvSocket
```

Перезапустите ВМ и подключитесь через «Подключение к виртуальной машине»
(не через RDP напрямую). При первом подключении появится диалог выбора
разрешения и параметров сессии.

## проверка Windows

```powershell
$vmName = "HV17-Debian-13-Java-Dev"

# 1. Проверка типа транспорта
(Get-VM -Name $vmName).EnhancedSessionTransportType
# Должно быть: HvSocket

# 2. Глобальный флаг хоста
(Get-VMHost).EnableEnhancedSessionMode
# Должно быть: True

# 3. Статус интеграционной службы "Обмен данными"
(Get-VMIntegrationService -VMName $vmName | Where-Object {$_.Name -eq "Guest Service Interface"}).Enabled
# Должно быть: True

# 4. КРИТИЧНО: версия сборки Windows
[System.Environment]::OSVersion.Version
# Должно быть: 10.0.17763.348 или новее (февраль 2019+)

# Рекомендуется: Generation 2
Get-VM $vmName | Select-Object Name, Generation
```

## проверка Debian

```bash
#Должно быть: active (running)
systemctl status hv-kvp-daemon --no-pager

# Должен быть вывод с "hv_utils"
lsmod | grep hv_utils

# Просмотр "осведомлённости" гипервизора
# Если есть строки вида KVP: IP address ... — демон работает и обменивается данными.
dmesg | grep -i "hyper-v" | grep -i "kvp"
# Или:
journalctl -u hv-kvp-daemon -n 20
```

## опции

### проверка физического размера сектора VHDX

```powershell
$vmName = "HV17-Debian-13-Java-Dev"
Get-VHD -Path H:\VMs\$vmName\disk-main.vhdx | 
  Select-Object Path, @{n="LogicalSectorSize";e={$_.LogicalSectorSize}}, `
                @{n="PhysicalSectorSize";e={$_.PhysicalSectorSize}}
```

### Полная оптимизация VHDX

требует предварительного монтирования в режиме только для чтения

```powershell
$vmName = "HV17-Debian-13-Java-Dev"
Mount-VHD H:\VMs\$vmName\disk-main.vhdx -ReadOnly
Optimize-VHD -Path H:\VMs\$vmName\disk-main.vhdx -Mode Full
Dismount-VHD H:\VMs\$vmName\disk-main.vhdx
```

### настройка памяти

```powershell
# Для ВМ с контейнерами/Minikube — ИСПОЛЬЗОВАТЬ СТАТИЧЕСКУЮ ПАМЯТЬ
Set-VMMemory -VMName $vmName -DynamicMemoryEnabled $false -StartupBytes 16GB

# Для простых ВМ без нагрузки — можно использовать динамическую
Set-VMMemory -VMName $vmName -DynamicMemoryEnabled $true `
  -MinimumBytes 2GB -StartupBytes 4GB -MaximumBytes 8GB -MemoryBuffer 20
```

### доп. настройки

[Hyper-V и виртуальные процессоры](https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/manage/manage-hyper-v-scheduler-types#virtual-machine-cpu-resource-controls-and-the-root-scheduler)

### проверка производительности - KDiskMark

```bash
sudo apt install kdiskmark
```

### Создание файла-маркера ОС (если гипервизор не распознаёт дистрибутив)

```bash
# Удаляем старый файл (если есть)
rm -f /var/lib/hyperv/.kvp_pool_3

# Создаём новый с правильным идентификатором
echo -n "Debian" | sudo tee /var/lib/hyperv/.kvp_pool_3
sudo chown root:root /var/lib/hyperv/.kvp_pool_3
sudo chmod 644 /var/lib/hyperv/.kvp_pool_3

# Перезапуск демона
sudo systemctl restart hv-kvp-daemon
```
