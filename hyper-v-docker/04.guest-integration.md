# 04.guest-integration

## Установка компонентов интеграции в гостевой системе

```bash
# Обновление системы
sudo apt update && sudo apt upgrade -y

# Установка необходимых пакетов
#    hyperv-daemons \          # ← содержит ВСЕ демоны для Hyper-V (KVP/VSS/Fcopy)
#    xfce4 xfce4-goodies \     # ← лёгкое окружение для IDEA
#    xrdp xorgxrdp \           # ← для Enhanced Session Mode
#    dbus-x11                  # ← требуется для корректной работы xrdp

sudo apt install hyperv-daemons 
sudo apt install xfce4 xfce4-goodies xrdp xorgxrdp dbus-x11
```

## настройка автозапуска XFCE

1. создать файл ~/.xsession с указанием окружения

```bash
#!/bin/sh
# Отключаем композитинг для максимальной производительности
xfconf-query -c xfwm4 -p /general/use_compositing -s false

# Устраняем артефакты рендеринга Java-приложений (IntelliJ IDEA)
export _JAVA_AWT_WM_NONREPARENTING=1

export XDG_SESSION_TYPE=x11
# Запуск XFCE
exec startxfce4
```

2.выполнить - `chmod +x ~/.xsession`
3.перезапуск xrdp - `sudo systemctl restart xrdp`
4.ВМ для применения настроек гипервизора `sudo reboot`

## Проверка работы компонентов

```bash
# Проверка загруженных модулей Hyper-V
# Должны присутствовать:
# hv_vmbus, hv_utils, hv_balloon, hv_netvsc, hv_storvsc, hyperv_drm
lsmod | grep hv_

# 1. Статус KVP-демона (критичен для буфера обмена и разрешения)
systemctl status hv-kvp-daemon

# 2. Проверка активных демонов - должно быть 2 шт
ps aux | grep -E 'hv_(kvp|vss)_daemon'

```

файлы в /var/lib/hyperv/ создаются автоматически демоном hv_kvp_daemon
 .kvp_pool_0, .kvp_pool_1, .kvp_pool_2, .kvp_pool_3,  .kvp_pool_4
💡 Размер 40960 байт у .kvp_pool_3 — это признак активной работы демона и обмена данными с гипервизором. Всё работает корректно.

После перезагрузки ВМ подключитесь через:
Диспетчер Hyper-V → ПКМ по ВМ → "Подключение"

В консоли должно появиться диалоговое окно с выбором:
 • Разрешения экрана
 • Качества отображения
 • Перенаправления устройств
 → Это признак активного Enhanced Session!

*примечания*:

- При использовании стандартной консоли (без Enhanced Session) динамическое
 разрешение и буфер обмена работать не будут — это ограничение архитектуры
 Hyper-V. Enhanced Session Mode — единственный рабочий путь.
- вкл/выкл расширенной сессии - на toolbar Hyper-V окна VM, рядом с
  turn off/shutdown
- Если после перезагрузки сессия не переключается в «улучшенный» режим —
 проверьте наличие файла .kvp_pool_3 и статус hv-kvp-daemon.
- Видеодрайвер: Убедитесь, что загружен hyperv_drm (проверяется через `lsmod | grep hyperv_drm`)
- Окружение: Используйте лёгкие DE (XFCE, LXQt) — меньше нагрузка на GPU эмуляцию
- Память: Выделите минимум 4–8 ГБ оперативной памяти для комфортной работы с GUI
- Отключение ненужных эффектов: В настройках DE отключите анимации и прозрачность
